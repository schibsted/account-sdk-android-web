language: android
dist: trusty
jdk: openjdk11

android:
  components:
    - build-tools-29.0.3

env:
  global:
    # GH_TOKEN
    - secure: "n7blhZYs6/0J+1q/MP0U9aOTuWUxLDwg+O08km4H1dVIMMCx0POTyNW7kLQ1m0oAcBateMFStRpuBAObR5h6SgWDC50SbKYjWaeZrqrA0EKpd5yAsXSbg6y5F8jobogd2kfyHJtgdPU5laysfw0jVOl8Vt3WwXP0JnfNT2fzSSv6B/scDnkFj0XjuOLRMW508L8JYY6d9J3kXXvOIt14M0hGUGbC+h7zFArRgwfXnPjNZ1cWrXXqjOe9fjHkwRGJ3QnwQxsiM6M3JTLtGk3SSyJMyNI7CTGH9M5jpZzcd3TkRkS26Evx8dnUENH5giB9cFpSgnRR5dW/UykxMlamlgEIdMgKepjWRbWR8uks1FP9pl1Q6Bw8dBMUr8baWq41Z65cD8ucyNhcUfsGIaJoPxKVBF0gke8NWNlbOW7Auo1mBxpxRJ2X/U3N0zniij7zz4MFdo1fTHb1jY7G9UFchWDnT9Moi97mv5+vzL+R1R0EIsUE9DrrjPeaC/lNTFp4kVUdUbZT91kce1CP2XQfQ8WGfwI0V8E1mzj8/0VoXyKj7XZIf7x3mZALSPNyYWc8pzIScsrPBB0ZTLKeWY3iKGTzzWz4lZ9e9P8FBsStxCV8tiQkJLd9hgNtvReVFBpSGMXZnzlI3quW38YaX0m8IgendFs9gmeYKiTmZJMUgSs="
    - ORG_GRADLE_PROJECT_sonatypeUsername=samuelg
    # Encrypted ORG_GRADLE_PROJECT_sonatypePassword
    - secure: "LNlry39I/iQt/3vR31WHhg33w1amttlzcpKE4zIb5V2bDcQ9aTHiqNKdmUyx2DmGxVtEFc5zuZUbbnwi+sGJjLronbqS0Rt8Ol9IkCZm9Hs6zmql9y8wh3OgwyXMuZaEpojJtGI0FR0MH9cAC1f/gXf684Zf+r3axQiZX8OvIRgCf1mLR8dfnM1ul46wYu0A0moW0qrOiZnFDkxxhgXjczgRzEp0ErNfv6waRifX230h/fm9sKA3o6tpaw76njZ+WEQGEvYM73VuREcwU9DI2qj3/8JS4LtQcACwvT5T8YVA8QnctL+3MdVVcdnCixT0ZDz6iU2rKvq7H7LQ80WlbLC0l4oa5Q6GGk/GUVMutxiBhHm/gm7czbgUA9HCuKWctZFgjW9JRQbcP/YHislFZ1UzeahtotsX2LJIsprqlL7UTSL9w0Khxj7pAbMqbsns+xzIQl/GfkKJOSxhrr7tGilXmm9SLY+HQV1Vet04fy/L3yZToxmkfA61vsWF+wuCZc1axOdldFiumuzNSbqPIiCP4sv74a0GTBpZG++RtM8vjTY22gUOdfIYAJTuhZLe1q3wwjQ4GMEjuvCbTxAzzY8t01Ld1SanAidVzPeKdb4Qjj8Ic46tfUfGz3eccJljSJovfEWlULMhILHq6p0N/rbmQnSYSKNuiNhU7w65Olw="
    # Encrypted SIGNING_PASSWORD (encrypted SIGNING_KEY, Base64 encoded, is set in Travis environment variables)
    - secure: "wcFMA35xoWVepZ1wAQ//UL90GMQY2qWtKSVpoWLHgfSPHmeE/LIFNg8fXfH8ir09unD4SRWCPHxcPxV1jlDHaPw9cfkQfbUAhU8/KVxwIoZG0yHNOtqdJkZYdzvUaWSnpOGgdl/KtOV+Gdcucm7cmF8+mgnWPGdaUEZXDvc95O+qMmm4wPi2Sn2FPlsU0XKKmbhBGoY0QTKZYC+Js2vBT4phQAd9r4ou9VzDU0UYAZHTu8ekR7jKWTOmlk2cwlC7viUnBmOcNjQVEiDLQPde7BkX5d4pNVxCrzp12204Wd7nzkSE2iav+P+gx9olK00e3Jg3auDmgl7X2AZyLDX5WzEom+qW5SY4uF816RWRDOIWoSz3ZRlx9Z0bZAndgZilFNicCsfcPDD4Uq+bzVkKWToJeK/MHH6eqSyWrjnZ3ufuvFfUsiMWeRSDltTzhNI6ezHhyHJU01frUVIane8QR60aUmZjDklMApo7qRCDqpr7LATePSggpOFixm0/mfv+owI76mSmwQJmL+bLzn5DtgDY1XoE029+udZAAgROrXajtzTAaWn0aad7xklN0bUJBCdF2C8FhcKueUHR0VtNXy1xtzZApKtNMvbNmcB6yUDAquRLXqo2CLUaVzT6F6HOm4OpRbhyTKsb3BUmcfyhUe4UinmcD/2vRWhdm+JoASBEF8t6T+BE3R+BvuTanwfSUQHyvW/FZngCRcbIUiW+G1X9H+FXC/dUZy0XsS6zJcEYz7dVHh2BiMvGgf6fBrgLRzeaL4KBePPRnbVuajct6iDaDLRuHdFgbiQi0PyJlqjQBg===PXG9"

before_install:
  # @todo https://github.schibsted.io/spt-identity/t/issues/1672
  - touch $HOME/.android/repositories.cfg
  - wget "https://dl.google.com/android/repository/commandlinetools-linux-7302050_latest.zip" -O commandlinetools.zip
  - unzip commandlinetools.zip -d $ANDROID_HOME/
  - yes | $ANDROID_HOME/cmdline-tools/bin/sdkmanager "platforms;android-29" --sdk_root=$ANDROID_HOME
  - yes | $ANDROID_HOME/cmdline-tools/bin/sdkmanager "build-tools;29.0.3" --sdk_root=$ANDROID_HOME

script: ./gradlew build testRelease connectedCheck --exclude-task testDebugUnitTest

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

before_deploy:
  - >
    if ! [ "$BEFORE_DEPLOY_RUN" ]; then
      export BEFORE_DEPLOY_RUN=1
      ./gradlew dokkaHtml
      mkdir docs
      cp -r webflows/build/dokka/html/. docs/.
    fi

deploy:
  - provider: pages
    skip_cleanup: true
    github_token: $GH_TOKEN
    verbose: true
    local_dir: docs
    on:
      repo: schibsted/account-sdk-android-web
      branch: master

  - provider: script
    skip_cleanup: true
    script: ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository
    on:
      repo: schibsted/account-sdk-android-web
      tags: true
