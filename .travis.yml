language: android
dist: trusty
jdk: openjdk11

android:
  components:
    - build-tools-29.0.3

env:
  global:
    # GH_TOKEN
    - secure: "n7blhZYs6/0J+1q/MP0U9aOTuWUxLDwg+O08km4H1dVIMMCx0POTyNW7kLQ1m0oAcBateMFStRpuBAObR5h6SgWDC50SbKYjWaeZrqrA0EKpd5yAsXSbg6y5F8jobogd2kfyHJtgdPU5laysfw0jVOl8Vt3WwXP0JnfNT2fzSSv6B/scDnkFj0XjuOLRMW508L8JYY6d9J3kXXvOIt14M0hGUGbC+h7zFArRgwfXnPjNZ1cWrXXqjOe9fjHkwRGJ3QnwQxsiM6M3JTLtGk3SSyJMyNI7CTGH9M5jpZzcd3TkRkS26Evx8dnUENH5giB9cFpSgnRR5dW/UykxMlamlgEIdMgKepjWRbWR8uks1FP9pl1Q6Bw8dBMUr8baWq41Z65cD8ucyNhcUfsGIaJoPxKVBF0gke8NWNlbOW7Auo1mBxpxRJ2X/U3N0zniij7zz4MFdo1fTHb1jY7G9UFchWDnT9Moi97mv5+vzL+R1R0EIsUE9DrrjPeaC/lNTFp4kVUdUbZT91kce1CP2XQfQ8WGfwI0V8E1mzj8/0VoXyKj7XZIf7x3mZALSPNyYWc8pzIScsrPBB0ZTLKeWY3iKGTzzWz4lZ9e9P8FBsStxCV8tiQkJLd9hgNtvReVFBpSGMXZnzlI3quW38YaX0m8IgendFs9gmeYKiTmZJMUgSs="
    - ORG_GRADLE_PROJECT_sonatypeUsername=samuelg
    # Encrypted ORG_GRADLE_PROJECT_sonatypePassword
    - secure: "ZBYMk0bM/ml7rkEjHxKTUOIusoUtV3QSLantVrAiGubtfm+LjnOo4wzjwmgfPPk+WytxqxS4FHRzrymzJC8NfxZtbl2rkWRQFoVEbE7U18LAyG51Ov/rIO+YDjszthucBPZ04m4Boza2kRIyTlNCikAgR0FlrhPC6TVKGzWS3VL7hNWaNOn8qDxx6mN0WsqQGjZipqGxyzHPnX3LLOODzcRSX3W9ZoXei6mcbOteAXci3q5PNwEnF1jOStTWFYsj5loJGQIHrXfegajWfwwxiMLvkcM6aF+Pc9qnOJ2qc68hhRBxou7NUuniQRt+felLym9496V6rZ3nNIyd+TLcQZcuSts7V74DXdj18mfhu1iXC1GuOOkeawjJ2q2mLQWrt61hHYrGFW69jQ9TMzqBYhNg5Lj1hqYNAFu6FWRh6ix2h33cyvSiEhW7lQnzm1xIjOgqMlwUozL391H5W0gO4eaJ9J3iQWvG/dFSxDGJh/QSBTUukAZuh1VtIkY9YbyampzmLD/PUzrnfJu0BZLZOmn6MhGZ+mDmm78vU8whAr/AceqovjiPqw8XF55fzxQllLaY3wJ2ux5YtG4yYyuFA86hEKdwHzHX+dkvIxt21ty0YBH/vQDpFNry2j8xpWwdTY8N4hl7rYtSAN4Jg2f0PR9G1TozZJ2c7BBKDHLdE1w="
    # Encrypted SIGNING_PASSWORD (encrypted SIGNING_KEY, Base64 encoded, is set in Travis environment variables)
    - secure: "hHJnXjsw0AjW46zLSEQzr+7m0YGLeryoszDjTnIMBiqDKiCaoJtpu3ZHdhU5G06cLtfbFXrY75GsgTEOt9GvBGTNr+e4FBk7O8wiEDTqpxH1X1A/mZZxud3pW7F2/icyBk4dKHmisBL2mWqtvJajKJByu7038UrTL73helb+x7n7JXp34qlI5ga4LzuH1j/ay1PgPandkyTcEs/il2hGxK2GqRBdgPEJUKO4i4HyLJI2EeYjZAClkDpkONM/XwbLJhylG54Wu4+rvuCTInjQEq0y11bOnxnC6SJxFAuXkJO9aulUJNOwN6m0KcQXVHIZEVi+VQ6P7TUBHDEI8z0amdcPc/u1TmMCzAbWf+BdkQs23XCVuON/DmDW0y2ltNYlJMekLh7i+F1rofsXUq/R1fnlFOg/IUKVxw8yDWtGo4+fNkE/pD6Ln8W2HnaOVVlhCugCWrey7MWv3VaOvRuwNdQmHf8fk3QIbE8Ny8IqKKabsUn7z2Xipa/HN/iU8lmPVMn0sjbNnJpYOnN3cirMRNV7eUEK3qFpjdMdPTHXljuexjQpp7qlIgez5Gyw0zjXFmgzp3Ewi+uJCal9aNyBirfVdq5SZmQH6961pwjGYrBUnhHKzfmcGp5K8IwpPz+VLZuQ8qE19cnIlWQYJ2TAgLNVGh9U+pg6YBRWmETs/jE="

before_install:
  # @todo https://github.schibsted.io/spt-identity/t/issues/1672
  - touch $HOME/.android/repositories.cfg
  - wget "https://dl.google.com/android/repository/commandlinetools-linux-7302050_latest.zip" -O commandlinetools.zip
  - unzip commandlinetools.zip -d $ANDROID_HOME/
  - yes | $ANDROID_HOME/cmdline-tools/bin/sdkmanager "platforms;android-29" --sdk_root=$ANDROID_HOME
  - yes | $ANDROID_HOME/cmdline-tools/bin/sdkmanager "build-tools;29.0.3" --sdk_root=$ANDROID_HOME

script: ./gradlew build testRelease connectedCheck --exclude-task testDebugUnitTest

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

before_deploy:
  - >
    if ! [ "$BEFORE_DEPLOY_RUN" ]; then
      export BEFORE_DEPLOY_RUN=1
      ./gradlew dokkaHtml
      mkdir docs
      cp -r webflows/build/dokka/html/. docs/.
    fi

deploy:
  - provider: pages
    skip_cleanup: true
    github_token: $GH_TOKEN
    verbose: true
    local_dir: docs
    on:
      repo: schibsted/account-sdk-android-web
      branch: master

  - provider: script
    skip_cleanup: true
    script: ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository
    on:
      repo: schibsted/account-sdk-android-web
      tags: true
